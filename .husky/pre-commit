#!/bin/sh

# Get current branch
branch=$(git rev-parse --abbrev-ref HEAD)

echo "Pre-commit hook running on branch: $branch"

# Always run lint
echo "Running lint..."
npm run lint || exit 1

# Always run build check
echo "Running build check..."
npm run build || exit 1

# If on main branch, run additional checks
if [ "$branch" = "main" ]; then
  echo ""
  echo "=========================================="
  echo "MAIN BRANCH COMMIT - Running API test"
  echo "=========================================="

  # Check if server is already running on port 3001 or 3000
  if curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/api/chat -X POST -H "Content-Type: application/json" -d '{"messages":[]}' 2>/dev/null | grep -q "^[245]"; then
    echo "Server detected on port 3001, running tests..."
    npm test || exit 1
  elif curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/chat -X POST -H "Content-Type: application/json" -d '{"messages":[]}' 2>/dev/null | grep -q "^[245]"; then
    echo "Server detected on port 3000, running tests..."
    npm test http://localhost:3000 || exit 1
  else
    echo ""
    echo "WARNING: Dev server not running. Skipping API test."
    echo "Please run 'npm run dev' and 'npm test' manually before pushing."
    echo ""
  fi
fi

echo ""
echo "Pre-commit checks passed!"
